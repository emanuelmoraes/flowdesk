rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function userPath(userId) {
      return /databases/$(database)/documents/users/$(userId);
    }

    function userExists(userId) {
      return exists(userPath(userId));
    }

    function validUserRole(role) {
      return ['user', 'manager', 'admin'].hasAny([role]);
    }

    function isAdmin() {
      return signedIn()
        && userExists(request.auth.uid)
        && get(userPath(request.auth.uid)).data.role == 'admin';
    }

    function isManager() {
      return signedIn()
        && userExists(request.auth.uid)
        && get(userPath(request.auth.uid)).data.role == 'manager';
    }

    function canManageAllProjects() {
      return isAdmin() || isManager();
    }

    function canDeleteProjects() {
      return isAdmin() || isManager();
    }

    function canManageUsers() {
      return isAdmin();
    }

    function projectPath(projectId) {
      return /databases/$(database)/documents/projects/$(projectId);
    }

    function projectExists(projectId) {
      return exists(projectPath(projectId));
    }

    function isProjectOwner(projectId) {
      return signedIn()
        && projectExists(projectId)
        && get(projectPath(projectId)).data.ownerId == request.auth.uid;
    }

    function isProjectMember(projectId) {
      return signedIn()
        && projectExists(projectId)
        && request.auth.uid in get(projectPath(projectId)).data.members;
    }

    function validStatus(status) {
      return ['backlog', 'todo', 'in-progress', 'review', 'done'].hasAny([status]);
    }

    function validPriority(priority) {
      return ['low', 'medium', 'high', 'urgent'].hasAny([priority]);
    }

    function validType(ticketType) {
      return ['bug', 'melhoria', 'tarefa', 'estoria', 'epico', 'investigacao', 'novidade', 'suporte'].hasAny([ticketType]);
    }

    function validProjectName(name) {
      return name is string && name.size() >= 3 && name.size() <= 120;
    }

    function validProjectDescription(description) {
      return description is string && description.size() <= 10000;
    }

    function validTicketTitle(title) {
      return title is string && title.size() >= 3 && title.size() <= 160;
    }

    function validTicketDescription(description) {
      return description is string && description.size() <= 10000;
    }

    function validTicketTags(tags) {
      return tags is list && tags.size() <= 10;
    }

    function validLogLevel(level) {
      return ['info', 'warn', 'error', 'success'].hasAny([level]);
    }

    function hasOnlyProjectFields() {
      return request.resource.data.keys().hasOnly([
        'name',
        'slug',
        'description',
        'ownerId',
        'members',
        'createdAt',
        'updatedAt'
      ]);
    }

    function hasOnlyTicketFields() {
      return request.resource.data.keys().hasOnly([
        'projectId',
        'title',
        'description',
        'status',
        'priority',
        'type',
        'tags',
        'assignee',
        'order',
        'createdAt',
        'updatedAt',
        'startDate',
        'dueDate',
        'estimatedHours',
        'progress'
      ]);
    }

    function hasOnlyUserFields() {
      return request.resource.data.keys().hasOnly([
        'email',
        'displayName',
        'role',
        'createdAt',
        'lastLogin',
        'updatedAt'
      ]);
    }

    function hasOnlyLogFields() {
      return request.resource.data.keys().hasOnly([
        'timestamp',
        'retentionUntil',
        'level',
        'message',
        'userId',
        'action',
        'metadata',
        'page'
      ]);
    }

    match /projects/{projectId} {
      allow read: if isProjectMember(projectId) || canManageAllProjects();

      allow create: if signedIn()
        && hasOnlyProjectFields()
        && validProjectName(request.resource.data.name)
        && request.resource.data.slug is string
        && validProjectDescription(request.resource.data.description)
        && request.resource.data.ownerId == request.auth.uid
        && request.resource.data.members is list
        && request.auth.uid in request.resource.data.members
        && request.resource.data.createdAt == request.time
        && request.resource.data.updatedAt == request.time;

      allow update: if (isProjectOwner(projectId) || canManageAllProjects())
        && hasOnlyProjectFields()
        && validProjectName(request.resource.data.name)
        && validProjectDescription(request.resource.data.description)
        && request.resource.data.ownerId == resource.data.ownerId
        && request.resource.data.slug == resource.data.slug
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.updatedAt == request.time;

      allow delete: if isProjectOwner(projectId) || canDeleteProjects();
    }

    match /tickets/{ticketId} {
      allow read: if signedIn()
        && resource.data.projectId is string
        && (isProjectMember(resource.data.projectId) || canManageAllProjects());

      allow create: if signedIn()
        && hasOnlyTicketFields()
        && request.resource.data.projectId is string
        && (isProjectMember(request.resource.data.projectId) || canManageAllProjects())
        && validTicketTitle(request.resource.data.title)
        && validTicketDescription(request.resource.data.description)
        && validTicketTags(request.resource.data.tags)
        && request.resource.data.order is int
        && validStatus(request.resource.data.status)
        && validPriority(request.resource.data.priority)
        && validType(request.resource.data.type)
        && request.resource.data.createdAt == request.time
        && request.resource.data.updatedAt == request.time;

      allow update: if signedIn()
        && hasOnlyTicketFields()
        && resource.data.projectId is string
        && (isProjectMember(resource.data.projectId) || canManageAllProjects())
        && request.resource.data.projectId == resource.data.projectId
        && request.resource.data.createdAt == resource.data.createdAt
        && validTicketTitle(request.resource.data.title)
        && validTicketDescription(request.resource.data.description)
        && validTicketTags(request.resource.data.tags)
        && request.resource.data.order is int
        && validStatus(request.resource.data.status)
        && validPriority(request.resource.data.priority)
        && validType(request.resource.data.type)
        && request.resource.data.updatedAt == request.time;

      allow delete: if signedIn()
        && resource.data.projectId is string
        && (isProjectMember(resource.data.projectId) || canManageAllProjects());
    }

    match /users/{userId} {
      allow read: if signedIn() && (request.auth.uid == userId || canManageUsers());

      allow create: if signedIn()
        && request.auth.uid == userId
        && hasOnlyUserFields()
        && request.resource.data.email is string
        && request.resource.data.role == 'user'
        && request.resource.data.createdAt == request.time
        && request.resource.data.lastLogin == request.time;

      allow update: if signedIn()
        && (request.auth.uid == userId || canManageUsers())
        && hasOnlyUserFields()
        && request.resource.data.email == resource.data.email
        && validUserRole(request.resource.data.role)
        && (canManageUsers() || request.resource.data.role == resource.data.role)
        && request.resource.data.createdAt == resource.data.createdAt
        && (!request.resource.data.keys().hasAny(['lastLogin']) || request.resource.data.lastLogin == request.time || request.resource.data.lastLogin == resource.data.lastLogin)
        && (!request.resource.data.keys().hasAny(['updatedAt']) || request.resource.data.updatedAt == request.time || request.resource.data.updatedAt == resource.data.updatedAt);

      allow delete: if false;
    }

    match /logs/{logId} {
      allow create: if signedIn()
        && hasOnlyLogFields()
        && request.resource.data.level is string
        && validLogLevel(request.resource.data.level)
        && request.resource.data.message is string
        && request.resource.data.message.size() > 0
        && request.resource.data.message.size() <= 2000
        && request.resource.data.timestamp == request.time
        && request.resource.data.retentionUntil is timestamp
        && request.resource.data.retentionUntil >= request.time + duration.value(30, 'd')
        && request.resource.data.retentionUntil <= request.time + duration.value(365, 'd');

      allow read: if canManageUsers();

      allow update, delete: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
